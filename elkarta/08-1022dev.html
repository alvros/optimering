<!DOCTYPE html>
<html>
<head>
    <title>Optimering Beta 5.01</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="css/081022.css">
</head>
<body>

<!-- Header -->
<div class="fixed-header">
    <button id="menu-toggle" class="hamburger-button">☰</button>
    <a href="../index.html"><img src="../tasks.png" alt="Tasks Logo" class="header-logo"/></a>
    <h1></h1>
</div>      

<div id="wrapper" class="toggled">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav" id="side_bar">
            <li class="sidebar-brand">
                <a href="../index.html">
                    <img src="../lkab2.png" alt="LKAB Logo" class="sidebar-logo">
                </a>                
            </li>
            <hr>
            <li class="dropdown">
                <a href="#" data-target="#kartorSubmenu" class="submenu-toggle">Kartor</a>                
                <ul class="submenu" id="kartorSubmenu">
                    <li class="dropdown">
                        <a href="#" data-target="#elSubmenu" class="submenu-toggle">EL</a>
                        <ul class="submenu" id="elSubmenu">
                            <li><a href="08-1022.html">08/1022</a></li>
                            <li><a href="12-1051.html">12/1051</a></li>
                            <li><a href="15-1079.html">15/1079</a></li>
                            <li><a href="22-1108.html">22/1108</a></li>
                            <li><a href="26-1108.html">26/1108</a></li>
                            <li><a href="30-1108.html">30/1108</a></li>
                            <li><a href="34-1079.html">34/1079</a></li>
                            <li><a href="34-1108.html">34/1108</a></li>
                            <li><a href="38-1108.html">38/1108</a></li>
                            <li><a href="41-1108soder.html">41/1108</a></li>                    
                        </ul>
                    </li>                    
                    <li class="dropdown">
                        <a href="#" data-target="#dieselSubmenu" class="submenu-toggle">Diesel</a>
                        <ul class="submenu" id="dieselSubmenu">
                            <li><a href="../dikarta/08-1022d.html">08/1022</a></li>
                            <li><a href="../dikarta/12-1051d.html">12/1051</a></li>
                            <li><a href="../dikarta/15-1079d.html">15/1079</a></li>
                            <li><a href="../dikarta/22-1108d.html">22/1108</a></li>
                            <li><a href="../dikarta/26-1108d.html">26/1108</a></li>
                            <li><a href="../dikarta/30-1108d.html">30/1108</a></li>
                            <li><a href="../dikarta/34-1079d.html">34/1079</a></li>
                            <li><a href="../dikarta/34-1108d.html">34/1108</a></li>
                            <li><a href="../dikarta/38-1108d.html">38/1108</a></li>
                            <li><a href="../dikarta/41-1108soderd.html">41/1108</a></li>                    
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="signature">
            <p>Fredrik Alvros<br><a href="mailto:fredrik.alvros@lkab.com">fredrik.alvros@lkab.com</a></p>
            </li> 
        </ul>
    </div> 

    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                  <div class="content">
                    <h2 id="map-title">08/1022</h2>
                    <div id="map-container">
                        <img src="../1313/081022.png" alt="Gruvkarta">
                        <div class="road" id="road1"></div>
                        <div class="road" id="road2"></div>
                        <div class="road" id="road3"></div>
                        <div class="road" id="road4"></div>
                        <div class="road" id="road5"></div>
                        <div class="road" id="road6"></div>
                        <div class="road" id="road7"></div>
                        <div class="road" id="road8"></div>
                        <div class="road" id="road9"></div>
                        <div class="road" id="road10"></div>
                        <div class="road" id="road11"></div>
                        <div class="road" id="road12"></div>                        
                    </div>
                    
                    <!-- Save Button Under Map -->
                    <div class="save-buttons">
                        <button id="saveButtonUnderMap" class="save-button">Spara Ändringar</button>
                    </div>
                </div>
                
                <script src="../script.js"></script>
                
                <div class="comments-section">
                    <div class="save-buttons">
                        <button id="saveButtonAboveTable" class="save-button">Spara Ändringar</button>
                        <button id="exportCsvButton" class="save-button">Exportera till CSV</button>
                    </div>
                    <table id="commentsTable">
                        <thead>
                            <tr>
                                <th class="ort-column">Ort</th>
                                <th class="status-column">Status</th>
                                <th class="datum-column">Datum</th>
                                <th class="kommentar-column">Kommentar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-road-id="road1">
                                <td>Ort 80</td>
                                <td><select id="status-road1">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road1"></td>
                                <td><input type="text" id="comment-road1"></td>
                            </tr>
                            <tr data-road-id="road2">
                                <td>82</td>
                                <td><select id="status-road2">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road2"></td>
                                <td><input type="text" id="comment-road2"></td>
                            </tr>
                            <!-- (Ytterligare rader för alla vägar som tidigare) -->
                            <tr data-road-id="road3">
                                <td>84</td>
                                <td><select id="status-road3">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road3"></td>
                                <td><input type="text" id="comment-road3"></td>
                            </tr>
                            <tr data-road-id="road4">
                                <td>86</td>
                                <td><select id="status-road4">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road4"></td>
                                <td><input type="text" id="comment-road4"></td>
                            </tr>
                            <!-- (Ytterligare rader för alla vägar som tidigare) -->
                        </tbody>
                    </table>
                </div>
                
                <div id="contextMenu" class="context-menu" style="display: none;">
                    <ul>
                        <li onclick="setRoadStatus('Optimerad')">Optimerad</li>
                        <li onclick="setRoadStatus('Planerad')">Planerad</li>
                        <li onclick="setRoadStatus('Avställd')">Avställd</li>
                        <li onclick="setRoadStatus('Ej Optimerad')">Ej optimerad</li>
                    </ul>
                </div>  
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", loadData);

    function loadData() {
        fetch("https://prod-116.westeurope.logic.azure.com:443/workflows/7efbd93f53e644bc9acc8f328b127034/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=3sl9Rl-3udA7v15DmbYIPcfZNSOGSf1escNF0_UbLug", {
            method: "GET",
            headers: {
                "Accept": "application/json; odata=verbose"
            }
        })
        .then(response => response.json())
        .then(data => {
            let items = data.d.results;
            let latestData = {};
    
            items.sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
    
            items.forEach(item => {
                if (!latestData[item.Gruvort]) {
                    latestData[item.Gruvort] = item;
                }
            });
    
            for (const roadId in latestData) {
                const item = latestData[roadId];
                document.querySelector(`#status-${roadId}`).value = item.Status;
                document.querySelector(`#date-${roadId}`).value = item.Datum ? item.Datum.split('T')[0] : '';
                document.querySelector(`#comment-${roadId}`).value = item.Kommentar;
            }
        })
        .catch(error => {
            console.error("Fel vid inläsning av data:", error);
            alert("Ett fel uppstod vid inläsning av data. Kontrollera nätverksanslutningen.");
        });
    }
    
    // Ta bort event listener på individuella fält om du inte vill spara vid varje ändring
    // document.querySelectorAll("input, select").forEach(element => {
    //     element.addEventListener("change", event => {
    //         let roadId = event.target.closest("tr").getAttribute("data-road-id");
    //         saveData(roadId); // Anropa saveData() med det specifika roadId som ändrats
    //     });
    // });
    
    function saveData(roadId) {
        let status = document.querySelector(`#status-${roadId}`).value;
        let date = document.querySelector(`#date-${roadId}`).value;
        let comment = document.querySelector(`#comment-${roadId}`).value;
    
        let formattedDate = date ? new Date(date).toISOString().split("T")[0] : "";
    
        let data = [{
            Gruvort: roadId,
            Status: status,
            Datum: formattedDate,
            Kommentar: comment
        }];
    
        fetch("https://prod-193.westeurope.logic.azure.com:443/workflows/e5d2364a7ba24bd39349a4c354aac388/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=rcDAKsEPQPI8xrCxDXmr9LXpQWO-lMalWK4xnFNem9s", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                console.log("Ändringarna har sparats!");
            } else {
                console.error("Kunde inte spara ändringarna. Försök igen senare.");
            }
        })
        .catch(error => {
            console.error("Fel vid sparande:", error);
        });
    }
    
    function saveAllData() {
        const dataToSend = [];
        const rows = document.querySelectorAll("#commentsTable tbody tr");
    
        rows.forEach(row => {
            const roadId = row.getAttribute("data-road-id");
            const status = row.querySelector(`#status-${roadId}`).value;
            const date = row.querySelector(`#date-${roadId}`).value;
            const comment = row.querySelector(`#comment-${roadId}`).value;
    
            const formattedDate = date ? new Date(date).toISOString().split("T")[0] : "";
    
            const rowData = {
                Gruvort: roadId,
                Status: status,
                Datum: formattedDate,
                Kommentar: comment
            };
    
            dataToSend.push(rowData);
        });
    
        fetch("https://prod-193.westeurope.logic.azure.com:443/workflows/e5d2364a7ba24bd39349a4c354aac388/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=rcDAKsEPQPI8xrCxDXmr9LXpQWO-lMalWK4xnFNem9s", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(dataToSend)
        })
        .then(response => {
            if (response.ok) {
                alert("Ändringarna har sparats!");
            } else {
                console.error("Kunde inte spara ändringarna. Försök igen senare.");
                alert("Ett fel uppstod vid sparande av ändringarna.");
            }
        })
        .catch(error => {
            console.error("Fel vid sparande:", error);
            alert("Ett fel uppstod vid sparande av ändringarna. Kontrollera nätverksanslutningen.");
        });
    }
    
    // Event Listener för "Spara Ändringar"-knappen
    document.getElementById("saveButtonUnderMap").addEventListener("click", saveAllData);
    document.getElementById("saveButtonAboveTable").addEventListener("click", saveAllData);
    
    
       
</script>

</body>
</html>
