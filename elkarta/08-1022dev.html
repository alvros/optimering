<!DOCTYPE html>
<html>
<head>
    <title>Optimering Beta 5.01</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="css/081022.css">
</head>
<body>

<!-- Header -->
<div class="fixed-header">
    <button id="menu-toggle" class="hamburger-button">☰</button>
    <a href="../index.html"><img src="../tasks.png" alt="Tasks Logo" class="header-logo"/></a>
    <h1></h1>
</div>      

<div id="wrapper" class="toggled">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav" id="side_bar">
            <li class="sidebar-brand">
                <a href="../index.html">
                    <img src="../lkab2.png" alt="LKAB Logo" class="sidebar-logo">
                </a>                
            </li>
            <hr>
            <li class="dropdown">
                <a href="#" data-target="#kartorSubmenu" class="submenu-toggle">Kartor</a>                
                <ul class="submenu" id="kartorSubmenu">
                    <li class="dropdown">
                        <a href="#" data-target="#elSubmenu" class="submenu-toggle">EL</a>
                        <ul class="submenu" id="elSubmenu">
                            <li><a href="08-1022.html">08/1022</a></li>
                            <li><a href="12-1051.html">12/1051</a></li>
                            <li><a href="15-1079.html">15/1079</a></li>
                            <li><a href="22-1108.html">22/1108</a></li>
                            <li><a href="26-1108.html">26/1108</a></li>
                            <li><a href="30-1108.html">30/1108</a></li>
                            <li><a href="34-1079.html">34/1079</a></li>
                            <li><a href="34-1108.html">34/1108</a></li>
                            <li><a href="38-1108.html">38/1108</a></li>
                            <li><a href="41-1108soder.html">41/1108</a></li>                    
                        </ul>
                    </li>                    
                    <li class="dropdown">
                        <a href="#" data-target="#dieselSubmenu" class="submenu-toggle">Diesel</a>
                        <ul class="submenu" id="dieselSubmenu">
                            <li><a href="../dikarta/08-1022d.html">08/1022</a></li>
                            <li><a href="../dikarta/12-1051d.html">12/1051</a></li>
                            <li><a href="../dikarta/15-1079d.html">15/1079</a></li>
                            <li><a href="../dikarta/22-1108d.html">22/1108</a></li>
                            <li><a href="../dikarta/26-1108d.html">26/1108</a></li>
                            <li><a href="../dikarta/30-1108d.html">30/1108</a></li>
                            <li><a href="../dikarta/34-1079d.html">34/1079</a></li>
                            <li><a href="../dikarta/34-1108d.html">34/1108</a></li>
                            <li><a href="../dikarta/38-1108d.html">38/1108</a></li>
                            <li><a href="../dikarta/41-1108soderd.html">41/1108</a></li>                    
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="signature">
            <p>Fredrik Alvros<br><a href="mailto:fredrik.alvros@lkab.com">fredrik.alvros@lkab.com</a></p>
            </li> 
        </ul>
    </div> 

    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                  <div class="content">
                    <h2 id="map-title">08/1022</h2>
                    <div id="map-container">
                        <img src="../1313/081022.png" alt="Gruvkarta">
                        <div class="road" id="road1"></div>
                        <div class="road" id="road2"></div>
                        <div class="road" id="road3"></div>
                        <div class="road" id="road4"></div>
                        <div class="road" id="road5"></div>
                        <div class="road" id="road6"></div>
                        <div class="road" id="road7"></div>
                        <div class="road" id="road8"></div>
                        <div class="road" id="road9"></div>
                        <div class="road" id="road10"></div>
                        <div class="road" id="road11"></div>
                        <div class="road" id="road12"></div>                        
                    </div>
                    
                    <!-- Save Button Under Map -->
                    <div class="save-buttons">
                        <button id="saveButtonUnderMap" class="save-button">Spara Ändringar</button>
                    </div>
                </div>
                
                <script src="../script.js"></script>
                
                <div class="comments-section">
                    <div class="save-buttons">
                        <button id="saveButtonAboveTable" class="save-button">Spara Ändringar</button>
                        <button id="exportCsvButton" class="save-button">Exportera till CSV</button>
                    </div>
                    <table id="commentsTable">
                        <thead>
                            <tr>
                                <th class="ort-column">Ort</th>
                                <th class="status-column">Status</th>
                                <th class="datum-column">Datum</th>
                                <th class="kommentar-column">Kommentar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-road-id="road1">
                                <td>Ort 80</td>
                                <td><select id="status-road1">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road1"></td>
                                <td><input type="text" id="comment-road1"></td>
                            </tr>
                            <tr data-road-id="road2">
                                <td>82</td>
                                <td><select id="status-road2">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road2"></td>
                                <td><input type="text" id="comment-road2"></td>
                            </tr>
                            <!-- (Ytterligare rader för alla vägar som tidigare) -->
                            <tr data-road-id="road3">
                                <td>84</td>
                                <td><select id="status-road3">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road3"></td>
                                <td><input type="text" id="comment-road3"></td>
                            </tr>
                            <tr data-road-id="road4">
                                <td>86</td>
                                <td><select id="status-road4">
                                    <option value="" selected>Välj status</option>
                                    <option>Optimerad</option>
                                    <option>Planerad</option>
                                    <option>Avställd</option>
                                    <option>Ej Optimerad</option>
                                </select></td>
                                <td><input type="date" id="date-road4"></td>
                                <td><input type="text" id="comment-road4"></td>
                            </tr>
                            <!-- (Ytterligare rader för alla vägar som tidigare) -->
                        </tbody>
                    </table>
                </div>
                
                <div id="contextMenu" class="context-menu" style="display: none;">
                    <ul>
                        <li onclick="setRoadStatus('Optimerad')">Optimerad</li>
                        <li onclick="setRoadStatus('Planerad')">Planerad</li>
                        <li onclick="setRoadStatus('Avställd')">Avställd</li>
                        <li onclick="setRoadStatus('Ej Optimerad')">Ej optimerad</li>
                    </ul>
                </div>  
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", loadData);

    function loadData() {
        fetch("https://din-power-automate-get-url-för-get-data", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            // Fyll i fälten med data från SharePoint
            data.forEach(item => {
                const roadId = item.Gruvort;
                document.querySelector(`#status-${roadId}`).value = item.Status;
                document.querySelector(`#date-${roadId}`).value = item.Datum;
                document.querySelector(`#comment-${roadId}`).value = item.Kommentar;
            });
        })
        .catch(error => {
            console.error("Fel vid inläsning av data:", error);
            alert("Ett fel uppstod vid inläsning av data. Kontrollera nätverksanslutningen.");
        });
    }

    document.getElementById("saveButtonUnderMap").addEventListener("click", () => {
        document.querySelectorAll("tr[data-road-id]").forEach(row => {
            let roadId = row.getAttribute("data-road-id");
            saveData(roadId);
        });
    });

    document.getElementById("saveButtonAboveTable").addEventListener("click", () => {
        document.querySelectorAll("tr[data-road-id]").forEach(row => {
            let roadId = row.getAttribute("data-road-id");
            saveData(roadId);
        });
    });

    document.getElementById("saveButtonBelowTable").addEventListener("click", () => {
        document.querySelectorAll("tr[data-road-id]").forEach(row => {
            let roadId = row.getAttribute("data-road-id");
            saveData(roadId);
        });
    });

    function saveData(roadId) {
        // Hämta all data för den specifika raden som har ändrats
        let status = document.querySelector(`#status-${roadId}`).value;
        let date = document.querySelector(`#date-${roadId}`).value;
        let comment = document.querySelector(`#comment-${roadId}`).value;

        // Omvandla datumet till ISO-format om det inte redan är det
        let formattedDate = date ? new Date(date).toISOString().split("T")[0] : "";

        // Bygg upp datan som ska skickas
        let data = {
            Gruvort: roadId,
            Status: status,
            Datum: formattedDate,
            Kommentar: comment
        };

        // Skicka data till Power Automate-flödet via HTTP POST
        fetch("https://prod-19.westeurope.logic.azure.com:443/workflows/39c38b174dc54475bb0d15fb59aaafbc/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=o5vfT9HLLyjrHRSYTyNEyHjpnp5drSky2_NPjI_ZD1g", { // Byt ut med din Power Automate URL
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                alert("Ändringarna har sparats!");
            } else {
                alert("Kunde inte spara ändringarna. Försök igen senare.");
            }
        })
        .catch(error => {
            console.error("Fel vid sparande:", error);
        });
    }

    function exportToCsv() {
        const roads = document.querySelectorAll(".comments-section tbody tr");
        let csvContent = "Gruvort,Status,Datum,Kommentar\n";

        roads.forEach(road => {
            let roadId = road.getAttribute("data-road-id");
            let status = road.querySelector(`#status-${roadId}`).value;
            let date = road.querySelector(`#date-${roadId}`).value;
            let comment = road.querySelector(`#comment-${roadId}`).value;

            csvContent += `${roadId},${status},${date},${comment}\n`;
        });

        // Skapa en nedladdningslänk för CSV-filen
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("href", url);
        a.setAttribute("download", "gruvdata.csv");
        a.click();
    }

</script>

</body>
</html>
